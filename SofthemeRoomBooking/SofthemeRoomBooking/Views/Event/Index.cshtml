@using Microsoft.AspNet.Identity
@model SofthemeRoomBooking.Models.EventViewModel.EventIndexViewModel

@Styles.Render("~/bundles/Styles/datetimepickers")

<div id="popup-confirmation" class="overlay"></div>

<div class="eventindex">
    <div class="eventindex-info">
        <p class="eventindex-info__title">@Model.Title</p>
        <p class="eventindex-info__autor">
            <i class="fa fa-user user-icon" aria-hidden="true"></i>
            <span class="user-name">@Model.Nickname</span>
        </p>
        <p class="eventindex-info__description">
            @Model.Description
        </p>

        @if (Model.AllowRegistration)
        {
            <div class="eventindex-info__join-to-event">
                <span>Планируют принять участие @Model.ParticipantsQuantity человек</span>
                
                @if (Model.IdUser != User.Identity.GetUserId())
                {
                    <span class="join-label">Присоединиться</span>
                    @Html.Action("AddParticipant", "Event", new { eventId =  Model.Id })
                }
            </div>
        }
    </div>

    <div class="eventindex-edit hidden"></div>

    <div class="eventindex-time">
        @Html.HiddenFor(model => model.Day)
        @Html.HiddenFor(model => model.Month)
        @Html.HiddenFor(model => model.Year)
        @Html.HiddenFor(model => model.StartHour)
        @Html.HiddenFor(model => model.StartMinutes)
        @Html.HiddenFor(model => model.EndHour)
        @Html.HiddenFor(model => model.EndMinutes)

        <div class="eventindex-time__header">
            <div class="event-date-container">
                <i class="fa fa-calendar calendar-icon" aria-hidden="true"></i>
                <div id="event-date" class="date"></div>
            </div>
            <div class="event-date-container">
                <i class="fa fa-clock-o clock-icon" aria-hidden="true"></i>
                <div id="event-timestart"></div> -
                <div id="event-timefinish"></div>
            </div>
        </div>
        <div class="eventindex-time__body">
            <i class="fa fa-calendar-plus-o" aria-hidden="true"></i>
            <i class="fa fa-envelope-o" aria-hidden="true"></i>
            <i class="fa fa-print" aria-hidden="true"></i>
        </div>

        @if (Model.IdUser == User.Identity.GetUserId())
        {
            <div class="eventindex-time__buttons">
                <button id="editButton" class="button event-btn edit-btn">Изменить</button>
                <button id="cancelEventButton" class="button event-btn cancel-btn">Отменить</button>
                <button id="cancelEditButton" class="button event-btn edit-btn hidden">Отменить</button>
                <button id="saveButton" class="button event-btn save-btn hidden">Сохранить</button>
            </div>
            <div id="event-errors" class="eventindex-time__errors">
                <i class="fa fa-frown-o frown-icon" aria-hidden="true"></i>
                <span class="error-text">Эта аудитория занята на выбраное время. Выберите, пожалуйста, другое.</span>
            </div>
        }
    </div>
</div>

<div class="eventindex-participants">
    <p>Зарегистрированные участники:</p>
    <table class="eventindex-participants__participants-table">
        <tr>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
        </tr>

        <tr>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
        </tr>

        <tr>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
            <td>
                <i class="fa fa-circle" aria-hidden="true"></i>
                <div class="participants-table-item">
                    <span>user@softheme.com</span>
                    <i class="fa fa-times" aria-hidden="true"></i>
                </div>
            </td>
        </tr>
    </table>
</div>

@Scripts.Render("~/bundles/jqueryval")
@Scripts.Render("~/bundles/datetimepickers")
@Scripts.Render("~/bundles/events")

<script>
    $("#editButton").bind("click", function () {
        $("#editButton").addClass("hidden");
        $("#cancelEventButton").addClass("hidden");
        $(".eventindex-info").addClass("hidden");


        $("#cancelEditButton").removeClass("hidden");
        $("#saveButton").removeClass("hidden");
        $(".eventindex-edit").removeClass("hidden");

        $.ajax({
            url: window.location.origin + "/Event/EditEvent",
            method: "GET",
            data: { eventId: '@Model.Id' },
            dataType: 'html',
            success: function (result) {
                $('.eventindex-edit').html(result);
            }
        });
    });

    $("#cancelEditButton").bind("click", function () {
        $("#editButton").removeClass("hidden");
        $("#cancelEventButton").removeClass("hidden");
        $(".eventindex-info").removeClass("hidden");


        $("#cancelEditButton").addClass("hidden");
        $("#saveButton").addClass("hidden");
        $("#eventindex-editform").remove();
    });

    $("#cancelEventButton").bind("click", function(e) {
        e.preventDefault();
        debugger;
        $.ajax({
            url: window.location.origin + "/Event/CancelEventView",
            method: "GET",
            data: { participantId: '@Model.Id' },
            dataType: 'html',
            success: function (result) {
                $('#popup-confirmation').html(result);
                $('#popup-confirmation').show();
            }
        });
    });

    $("#saveButton").bind("click", function (e) {
        e.preventDefault();
        debugger;
        var dateTimeValidator = dateTimeEventValidate();

        if (dateTimeValidator.validate() && $("#eventindex-editform").valid()) {
            debugger;
            $.ajax({
                url: window.location.origin + "/Event/EditEvent",
                method: "POST",
                async: true,
                data: $("#eventindex-editform").serialize(),
                success: function (result) {
                    if (result.redirectTo) {
                        window.location.href = result.redirectTo;
                    } else if (result.errorMessage) {
                        dateTimeValidator.showErrors(false, result.errorMessage);
                    }
                }
            });
            return true;
        } else {
            return false;
        }
    });
</script>

@Html.Action("RoomPartial", "Room")

@Html.Partial("_MapPartial")

